<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Dashboard - IVF Platform</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .finance-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .finance-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .finance-card.revenue { border-left: 4px solid #10b981; }
        .finance-card.expense { border-left: 4px solid #ef4444; }
        .finance-card.profit { border-left: 4px solid #3b82f6; }
        .finance-card.pending { border-left: 4px solid #f59e0b; }
        .finance-card h3 { font-size: 28px; margin: 10px 0 5px; }
        .finance-card p { color: #666; font-size: 13px; margin: 0; }
        .finance-card .trend { font-size: 12px; margin-top: 8px; }
        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }
        
        .chart-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-header h3 { margin: 0; font-size: 16px; }
        
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .charts-row-equal { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .quick-actions { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .quick-action-btn { background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .quick-action-btn:hover { border-color: #667eea; background: #f8faff; transform: translateY(-2px); }
        .quick-action-btn .icon { font-size: 28px; margin-bottom: 8px; }
        .quick-action-btn .label { font-size: 12px; color: #666; }
        
        .alert-card { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .alert-card.danger { background: #fee2e2; border-color: #ef4444; }
        .alert-card .alert-icon { font-size: 24px; }
        .alert-card .alert-content { flex: 1; }
        .alert-card .alert-title { font-weight: bold; margin-bottom: 3px; }
        .alert-card .alert-desc { font-size: 12px; color: #666; }
        
        .recent-table { width: 100%; }
        .recent-table th, .recent-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .recent-table th { background: #f8fafc; font-weight: 600; font-size: 12px; color: #666; text-transform: uppercase; }
        
        .amount-positive { color: #10b981; font-weight: bold; }
        .amount-negative { color: #ef4444; font-weight: bold; }
        
        .period-selector { display: flex; gap: 5px; }
        .period-btn { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .period-btn.active { background: #667eea; color: white; border-color: #667eea; }
        
        @media (max-width: 1200px) {
            .finance-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
                        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üè• IVF Platform</h2>
                <p id="clinicName">Loading...</p>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item"><span>üìä</span> Dashboard</a>
                <a href="patients.html" class="nav-item"><span>üë•</span> Patients</a>
                <a href="cycles.html" class="nav-item"><span>üîÑ</span> Cycles</a>
                <a href="lab.html" class="nav-item"><span>üî¨</span> Laboratory</a>
                <a href="lab-tests.html" class="nav-item"><span>üß™</span> Test Catalog</a>
                <a href="lab-orders.html" class="nav-item"><span>üìã</span> Lab Orders</a>
                <a href="finance.html" class="nav-item active"><span>üí∞</span> Finance</a>
                <a href="assets.html" class="nav-item"><span>üè∑Ô∏è</span> Assets</a>
                <a href="inventory.html" class="nav-item"><span>üì¶</span> Inventory</a>
                <a href="reports.html" class="nav-item"><span>üìà</span> Reports</a>
                <a href="settings.html" class="nav-item"><span>‚öôÔ∏è</span> Settings</a>
                <a href="organization-settings.html" class="nav-item"><span>üè¢</span> Organization</a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <p id="userName">Loading...</p>
                    <p id="userRole" class="text-muted">Role</p>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-sm" style="width:100%;">Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h1>üí∞ Finance Dashboard</h1>
                <div class="period-selector">
                    <button class="period-btn" onclick="setPeriod('today')">Today</button>
                    <button class="period-btn" onclick="setPeriod('week')">This Week</button>
                    <button class="period-btn active" onclick="setPeriod('month')">This Month</button>
                    <button class="period-btn" onclick="setPeriod('year')">This Year</button>
                </div>
            </div>

            <!-- Alerts Section -->
            <div id="alertsSection">
                <!-- Dynamic alerts will be inserted here -->
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="openModal('revenueModal')">
                    <div class="icon">üíµ</div>
                    <div class="label">Record Revenue</div>
                </div>
                <div class="quick-action-btn" onclick="openModal('expenseModal')">
                    <div class="icon">üìù</div>
                    <div class="label">Add Expense</div>
                </div>
                <div class="quick-action-btn" onclick="location.href='assets.html'">
                    <div class="icon">üè∑Ô∏è</div>
                    <div class="label">Manage Assets</div>
                </div>
                <div class="quick-action-btn" onclick="openModal('contractModal')">
                    <div class="icon">üìÑ</div>
                    <div class="label">Add Contract</div>
                </div>
                <div class="quick-action-btn" onclick="generateReport()">
                    <div class="icon">üìä</div>
                    <div class="label">Generate Report</div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="finance-grid">
                <div class="finance-card revenue">
                    <p>Total Revenue</p>
                    <h3 id="totalRevenue">PKR 0</h3>
                    <div class="trend up" id="revenueTrend">‚Üë 0% from last period</div>
                </div>
                <div class="finance-card expense">
                    <p>Total Expenses</p>
                    <h3 id="totalExpenses">PKR 0</h3>
                    <div class="trend down" id="expenseTrend">‚Üë 0% from last period</div>
                </div>
                <div class="finance-card profit">
                    <p>Net Profit</p>
                    <h3 id="netProfit">PKR 0</h3>
                    <div class="trend" id="profitTrend">Profit Margin: 0%</div>
                </div>
                <div class="finance-card pending">
                    <p>Pending Receivables</p>
                    <h3 id="pendingReceivables">PKR 0</h3>
                    <div class="trend" id="receivablesTrend">0 invoices pending</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üìà Revenue vs Expenses</h3>
                    </div>
                    <canvas id="revenueExpenseChart" height="100"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>ü•ß Expense Breakdown</h3>
                    </div>
                    <canvas id="expenseBreakdownChart" height="200"></canvas>
                </div>
            </div>

            <!-- Revenue by Source & Assets -->
            <div class="charts-row-equal">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üí∞ Revenue by Source</h3>
                    </div>
                    <canvas id="revenueSourceChart" height="150"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üè¢ Asset Value Distribution</h3>
                    </div>
                    <canvas id="assetValueChart" height="150"></canvas>
                </div>
            </div>

            <!-- Recent Transactions & Contracts -->
            <div class="charts-row-equal">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üìã Recent Transactions</h3>
                        <a href="#" onclick="viewAllTransactions()" style="font-size:12px;">View All ‚Üí</a>
                    </div>
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactions">
                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>üìÑ Expiring Contracts & Licenses</h3>
                        <a href="#" onclick="viewAllContracts()" style="font-size:12px;">View All ‚Üí</a>
                    </div>
                    <div id="expiringContracts">
                        <p class="text-muted text-center">Loading...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Revenue Modal -->
    <div id="revenueModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h2>üíµ Record Revenue</h2>
                <span class="close" onclick="closeModal('revenueModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="revenueForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" class="form-control" id="revDate" required>
                        </div>
                        <div class="form-group">
                            <label>Source Type *</label>
                            <select class="form-control" id="revSourceType" required>
                                <option value="patient_payment">Patient Payment</option>
                                <option value="lab_order">Lab Order</option>
                                <option value="procedure">Procedure</option>
                                <option value="consultation">Consultation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Patient (Optional)</label>
                        <select class="form-control" id="revPatientId">
                            <option value="">Select Patient</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" class="form-control" id="revDescription" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gross Amount *</label>
                            <input type="number" class="form-control" id="revGrossAmount" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Discount</label>
                            <input type="number" class="form-control" id="revDiscount" value="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Net Amount</label>
                            <input type="number" class="form-control" id="revNetAmount" readonly style="background:#f0f0f0;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select class="form-control" id="revPaymentMethod">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="insurance">Insurance</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reference #</label>
                            <input type="text" class="form-control" id="revReference">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('revenueModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveRevenue()">üíæ Save Revenue</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h2>üìù Add Expense</h2>
                <span class="close" onclick="closeModal('expenseModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" class="form-control" id="expDate" required>
                        </div>
                        <div class="form-group">
                            <label>Category *</label>
                            <select class="form-control" id="expCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Vendor / Payee</label>
                        <input type="text" class="form-control" id="expVendor">
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" class="form-control" id="expDescription" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Amount *</label>
                            <input type="number" class="form-control" id="expAmount" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select class="form-control" id="expPaymentMethod">
                                <option value="cash">Cash</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                                <option value="card">Card</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="expStatus">
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="expRecurring"> This is a recurring expense
                        </label>
                    </div>
                    <div id="recurringOptions" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frequency</label>
                                <select class="form-control" id="expFrequency">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" class="form-control" id="expEndDate">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('expenseModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveExpense()">üíæ Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Contract Modal -->
    <div id="contractModal" class="modal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h2>üìÑ Add Contract / License</h2>
                <span class="close" onclick="closeModal('contractModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="contractForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Contract Type *</label>
                            <select class="form-control" id="conType" required>
                                <option value="">Select Type</option>
                                <option value="license">License / Permit</option>
                                <option value="regulatory">Regulatory Compliance</option>
                                <option value="service">Service Contract</option>
                                <option value="maintenance">Maintenance Contract</option>
                                <option value="lease">Lease Agreement</option>
                                <option value="vendor">Vendor Contract</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Contract Name *</label>
                            <input type="text" class="form-control" id="conName" required placeholder="e.g., PHC License, Waste Management">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Party / Vendor Name</label>
                            <input type="text" class="form-control" id="conPartyName" placeholder="e.g., Punjab Healthcare Commission">
                        </div>
                        <div class="form-group">
                            <label>License / Contract Number</label>
                            <input type="text" class="form-control" id="conNumber">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" class="form-control" id="conStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" class="form-control" id="conEndDate">
                        </div>
                        <div class="form-group">
                            <label>Renewal Date</label>
                            <input type="date" class="form-control" id="conRenewalDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Contract Value</label>
                            <input type="number" class="form-control" id="conValue" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Frequency</label>
                            <select class="form-control" id="conPaymentFreq">
                                <option value="one_time">One Time</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="conAutoRenew"> Auto Renew
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control" id="conNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('contractModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveContract()">üíæ Save Contract</button>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let currentPeriod = 'month';
        let revenueExpenseChart, expenseBreakdownChart, revenueSourceChart, assetValueChart;

        document.addEventListener('DOMContentLoaded', function() {
            requireAuth();
            loadUserInfo();
            initializeForms();
            loadFinanceDashboard();
            loadExpenseCategories();
            loadPatients();
        });

        function initializeForms() {
            document.getElementById('revDate').valueAsDate = new Date();
            document.getElementById('expDate').valueAsDate = new Date();
            document.getElementById('conStartDate').valueAsDate = new Date();
            
            // Auto-calculate net amount
            document.getElementById('revGrossAmount').addEventListener('input', calculateNetAmount);
            document.getElementById('revDiscount').addEventListener('input', calculateNetAmount);
            
            // Toggle recurring options
            document.getElementById('expRecurring').addEventListener('change', function() {
                document.getElementById('recurringOptions').style.display = this.checked ? 'block' : 'none';
            });
        }

        function calculateNetAmount() {
            const gross = parseFloat(document.getElementById('revGrossAmount').value) || 0;
            const discount = parseFloat(document.getElementById('revDiscount').value) || 0;
            document.getElementById('revNetAmount').value = (gross - discount).toFixed(2);
        }

        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadFinanceDashboard();
        }

        async function loadFinanceDashboard() {
            try {
                const data = await apiCall(`/finance/dashboard?period=${currentPeriod}`);
                if (data && data.success) {
                    updateSummaryCards(data.data);
                    updateCharts(data.data);
                    loadRecentTransactions();
                    loadExpiringContracts();
                    loadAlerts(data.data);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Load with sample data for demo
                loadSampleData();
            }
        }

        function loadSampleData() {
            // Demo data when API not ready
            const sampleData = {
                totalRevenue: 1250000,
                totalExpenses: 450000,
                netProfit: 800000,
                pendingReceivables: 125000,
                pendingCount: 8,
                revenueByMonth: [120000, 150000, 180000, 140000, 200000, 160000],
                expensesByMonth: [40000, 50000, 60000, 45000, 55000, 65000],
                expensesByCategory: {
                    'Salaries': 180000,
                    'Medical Supplies': 80000,
                    'Utilities': 45000,
                    'Maintenance': 35000,
                    'Other': 110000
                },
                revenueBySource: {
                    'IVF Procedures': 600000,
                    'Lab Tests': 350000,
                    'Consultations': 200000,
                    'Medications': 100000
                },
                assetsByCategory: {
                    'Medical Equipment': 5000000,
                    'Lab Equipment': 2500000,
                    'Furniture': 800000,
                    'IT Equipment': 400000
                }
            };
            updateSummaryCards(sampleData);
            updateCharts(sampleData);
            
            document.getElementById('recentTransactions').innerHTML = `
                <tr><td>Today</td><td>IVF Procedure - Patient A</td><td><span class="badge badge-success">Revenue</span></td><td class="amount-positive">+PKR 150,000</td></tr>
                <tr><td>Today</td><td>Lab Supplies Purchase</td><td><span class="badge badge-danger">Expense</span></td><td class="amount-negative">-PKR 25,000</td></tr>
                <tr><td>Yesterday</td><td>Consultation - Patient B</td><td><span class="badge badge-success">Revenue</span></td><td class="amount-positive">+PKR 5,000</td></tr>
                <tr><td>Yesterday</td><td>Electricity Bill</td><td><span class="badge badge-danger">Expense</span></td><td class="amount-negative">-PKR 45,000</td></tr>
                <tr><td>Feb 12</td><td>Lab Tests - Multiple</td><td><span class="badge badge-success">Revenue</span></td><td class="amount-positive">+PKR 35,000</td></tr>
            `;
            
            document.getElementById('expiringContracts').innerHTML = `
                <div class="alert-card danger">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">PHC License</div>
                        <div class="alert-desc">Expires in 15 days - Renewal required</div>
                    </div>
                    <button class="btn btn-sm btn-primary">Renew</button>
                </div>
                <div class="alert-card">
                    <div class="alert-icon">üìÑ</div>
                    <div class="alert-content">
                        <div class="alert-title">Waste Management Contract</div>
                        <div class="alert-desc">Expires in 45 days</div>
                    </div>
                    <button class="btn btn-sm btn-secondary">View</button>
                </div>
                <div class="alert-card">
                    <div class="alert-icon">üìÑ</div>
                    <div class="alert-content">
                        <div class="alert-title">Equipment Maintenance</div>
                        <div class="alert-desc">Due for renewal in 60 days</div>
                    </div>
                    <button class="btn btn-sm btn-secondary">View</button>
                </div>
            `;
            
            document.getElementById('alertsSection').innerHTML = `
                <div class="alert-card danger">
                    <div class="alert-icon">üîî</div>
                    <div class="alert-content">
                        <div class="alert-title">PHC License Expiring Soon</div>
                        <div class="alert-desc">Your PHC license expires in 15 days. Please initiate renewal process.</div>
                    </div>
                    <button class="btn btn-sm btn-danger">Take Action</button>
                </div>
            `;
        }

        function updateSummaryCards(data) {
            document.getElementById('totalRevenue').textContent = formatCurrency(data.totalRevenue || 0);
            document.getElementById('totalExpenses').textContent = formatCurrency(data.totalExpenses || 0);
            document.getElementById('netProfit').textContent = formatCurrency(data.netProfit || 0);
            document.getElementById('pendingReceivables').textContent = formatCurrency(data.pendingReceivables || 0);
            
            const margin = data.totalRevenue > 0 ? ((data.netProfit / data.totalRevenue) * 100).toFixed(1) : 0;
            document.getElementById('profitTrend').textContent = `Profit Margin: ${margin}%`;
            document.getElementById('receivablesTrend').textContent = `${data.pendingCount || 0} invoices pending`;
        }

        function updateCharts(data) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            
            // Revenue vs Expense Chart
            if (revenueExpenseChart) revenueExpenseChart.destroy();
            revenueExpenseChart = new Chart(document.getElementById('revenueExpenseChart'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: data.revenueByMonth || [120000, 150000, 180000, 140000, 200000, 160000],
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderRadius: 6
                        },
                        {
                            label: 'Expenses',
                            data: data.expensesByMonth || [40000, 50000, 60000, 45000, 55000, 65000],
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => 'PKR ' + (v/1000) + 'K' } } }
                }
            });

            // Expense Breakdown Donut
            const expenseLabels = Object.keys(data.expensesByCategory || {});
            const expenseValues = Object.values(data.expensesByCategory || {});
            
            if (expenseBreakdownChart) expenseBreakdownChart.destroy();
            expenseBreakdownChart = new Chart(document.getElementById('expenseBreakdownChart'), {
                type: 'doughnut',
                data: {
                    labels: expenseLabels.length ? expenseLabels : ['Salaries', 'Supplies', 'Utilities', 'Other'],
                    datasets: [{
                        data: expenseValues.length ? expenseValues : [180000, 80000, 45000, 145000],
                        backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Revenue by Source
            const sourceLabels = Object.keys(data.revenueBySource || {});
            const sourceValues = Object.values(data.revenueBySource || {});
            
            if (revenueSourceChart) revenueSourceChart.destroy();
            revenueSourceChart = new Chart(document.getElementById('revenueSourceChart'), {
                type: 'pie',
                data: {
                    labels: sourceLabels.length ? sourceLabels : ['IVF', 'Lab Tests', 'Consultations', 'Other'],
                    datasets: [{
                        data: sourceValues.length ? sourceValues : [600000, 350000, 200000, 100000],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });

            // Asset Value Distribution
            const assetLabels = Object.keys(data.assetsByCategory || {});
            const assetValues = Object.values(data.assetsByCategory || {});
            
            if (assetValueChart) assetValueChart.destroy();
            assetValueChart = new Chart(document.getElementById('assetValueChart'), {
                type: 'doughnut',
                data: {
                    labels: assetLabels.length ? assetLabels : ['Medical', 'Lab', 'Furniture', 'IT'],
                    datasets: [{
                        data: assetValues.length ? assetValues : [5000000, 2500000, 800000, 400000],
                        backgroundColor: ['#ef4444', '#3b82f6', '#10b981', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        async function loadRecentTransactions() {
            // Will be loaded from API when ready
        }

        async function loadExpiringContracts() {
            // Will be loaded from API when ready
        }

        function loadAlerts(data) {
            // Will be loaded from API when ready
        }

        async function loadExpenseCategories() {
            try {
                const data = await apiCall('/finance/expense-categories');
                if (data && data.success) {
                    document.getElementById('expCategory').innerHTML = '<option value="">Select Category</option>' +
                        data.data.map(c => `<option value="${c.id}">${c.category_name}</option>`).join('');
                }
            } catch (error) {
                // Load defaults
                document.getElementById('expCategory').innerHTML = `
                    <option value="">Select Category</option>
                    <option value="sal">Salaries & Wages</option>
                    <option value="rent">Rent & Utilities</option>
                    <option value="med">Medical Supplies</option>
                    <option value="lab">Laboratory Supplies</option>
                    <option value="maint">Maintenance</option>
                    <option value="lic">Licenses & Permits</option>
                    <option value="other">Other</option>
                `;
            }
        }

        async function loadPatients() {
            try {
                const data = await apiCall('/patients');
                if (data && data.patients) {
                    document.getElementById('revPatientId').innerHTML = '<option value="">Select Patient</option>' +
                        data.patients.map(p => `<option value="${p.id}">${p.full_name} (${p.mrn || ''})</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        async function saveRevenue() {
            const formData = {
                transaction_date: document.getElementById('revDate').value,
                source_type: document.getElementById('revSourceType').value,
                patient_id: document.getElementById('revPatientId').value || null,
                description: document.getElementById('revDescription').value,
                gross_amount: document.getElementById('revGrossAmount').value,
                discount_amount: document.getElementById('revDiscount').value || 0,
                net_amount: document.getElementById('revNetAmount').value,
                payment_method: document.getElementById('revPaymentMethod').value,
                payment_reference: document.getElementById('revReference').value
            };

            if (!formData.transaction_date || !formData.description || !formData.gross_amount) {
                alert('Please fill required fields');
                return;
            }

            try {
                const data = await apiCall('/finance/revenue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (data && data.success) {
                    alert('‚úì Revenue recorded successfully!');
                    closeModal('revenueModal');
                    loadFinanceDashboard();
                } else {
                    alert('Error: ' + (data?.message || 'Failed to save'));
                }
            } catch (error) {
                alert('Revenue recorded (demo mode)');
                closeModal('revenueModal');
            }
        }

        async function saveExpense() {
            const formData = {
                expense_date: document.getElementById('expDate').value,
                category_id: document.getElementById('expCategory').value,
                vendor_name: document.getElementById('expVendor').value,
                description: document.getElementById('expDescription').value,
                amount: document.getElementById('expAmount').value,
                payment_method: document.getElementById('expPaymentMethod').value,
                payment_status: document.getElementById('expStatus').value,
                is_recurring: document.getElementById('expRecurring').checked,
                recurring_frequency: document.getElementById('expFrequency').value,
                recurring_end_date: document.getElementById('expEndDate').value
            };

            if (!formData.expense_date || !formData.description || !formData.amount) {
                alert('Please fill required fields');
                return;
            }

            try {
                const data = await apiCall('/finance/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (data && data.success) {
                    alert('‚úì Expense recorded successfully!');
                    closeModal('expenseModal');
                    loadFinanceDashboard();
                } else {
                    alert('Error: ' + (data?.message || 'Failed to save'));
                }
            } catch (error) {
                alert('Expense recorded (demo mode)');
                closeModal('expenseModal');
            }
        }

        async function saveContract() {
            const formData = {
                contract_type: document.getElementById('conType').value,
                contract_name: document.getElementById('conName').value,
                party_name: document.getElementById('conPartyName').value,
                contract_number: document.getElementById('conNumber').value,
                start_date: document.getElementById('conStartDate').value,
                end_date: document.getElementById('conEndDate').value,
                renewal_date: document.getElementById('conRenewalDate').value,
                contract_value: document.getElementById('conValue').value,
                payment_frequency: document.getElementById('conPaymentFreq').value,
                auto_renew: document.getElementById('conAutoRenew').checked,
                notes: document.getElementById('conNotes').value
            };

            if (!formData.contract_type || !formData.contract_name || !formData.start_date) {
                alert('Please fill required fields');
                return;
            }

            try {
                const data = await apiCall('/finance/contracts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (data && data.success) {
                    alert('‚úì Contract saved successfully!');
                    closeModal('contractModal');
                    loadFinanceDashboard();
                } else {
                    alert('Error: ' + (data?.message || 'Failed to save'));
                }
            } catch (error) {
                alert('Contract saved (demo mode)');
                closeModal('contractModal');
            }
        }

        function generateReport() {
            alert('Financial Report Generation\n\nThis will generate a comprehensive financial report for the selected period.\n\nComing soon!');
        }

        function viewAllTransactions() {
            alert('View All Transactions - Coming Soon');
        }

        function viewAllContracts() {
            alert('View All Contracts - Coming Soon');
        }

        function formatCurrency(amount) {
            return 'PKR ' + (parseFloat(amount) || 0).toLocaleString();
        }

        function openModal(id) { 
            document.getElementById(id).style.display = 'block'; 
        }
        
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
        }
        
        window.onclick = function(e) { 
            if (e.target.classList.contains('modal')) e.target.style.display = 'none'; 
        };
    </script>
</body>
</html>
